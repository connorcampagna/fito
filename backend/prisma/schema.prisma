// Fito Database Schema
// Production-ready with Users, Subscriptions, Clothing, and Outfits

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// USER & AUTHENTICATION
// ============================================

model User {
  id            String   @id @default(cuid())
  email         String   @unique
  passwordHash  String?  // Null for Apple/Google sign-in
  name          String?
  profileImage  String?
  gender        String?  // male, female, non-binary
  ageRange      String?  // 18-24, 25-34, etc.
  
  // Auth providers
  appleId       String?  @unique
  googleId      String?  @unique
  
  // Timestamps
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  lastLoginAt   DateTime?
  
  // Relations
  subscription  Subscription?
  clothingItems ClothingItem[]
  outfits       Outfit[]
  usageLogs     UsageLog[]
  refreshTokens RefreshToken[]
  
  @@index([email])
  @@index([appleId])
  @@index([googleId])
}

model RefreshToken {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime
  createdAt DateTime @default(now())
  
  @@index([userId])
  @@index([token])
}

// ============================================
// SUBSCRIPTIONS & PAYMENTS
// ============================================

enum SubscriptionTier {
  FREE
  PRO
  PREMIUM
}

enum SubscriptionStatus {
  ACTIVE
  PAST_DUE
  CANCELED
  EXPIRED
  TRIALING
}

model Subscription {
  id                   String             @id @default(cuid())
  userId               String             @unique
  user                 User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Subscription details
  tier                 SubscriptionTier   @default(FREE)
  status               SubscriptionStatus @default(ACTIVE)
  
  // Stripe integration
  stripeCustomerId     String?            @unique
  stripeSubscriptionId String?            @unique
  stripePriceId        String?
  
  // Apple In-App Purchase
  appleOriginalTransactionId String?      @unique
  appleProductId       String?
  
  // Limits & usage
  monthlyOutfitLimit   Int                @default(10)  // FREE = 10, PRO = 100, PREMIUM = unlimited
  monthlyOutfitsUsed   Int                @default(0)
  usageResetDate       DateTime           @default(now())
  
  // Billing dates
  currentPeriodStart   DateTime?
  currentPeriodEnd     DateTime?
  cancelAtPeriodEnd    Boolean            @default(false)
  
  // Timestamps
  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @updatedAt
  
  @@index([stripeCustomerId])
  @@index([stripeSubscriptionId])
  @@index([appleOriginalTransactionId])
}

model SubscriptionPrice {
  id            String           @id @default(cuid())
  tier          SubscriptionTier
  stripePriceId String           @unique
  appleProductId String?         @unique
  
  // Pricing info
  amount        Int              // In cents (e.g., 999 = $9.99)
  currency      String           @default("usd")
  interval      String           // month, year
  
  // Display info
  name          String           // "Pro Monthly"
  description   String?
  features      String[]         // ["100 outfits/month", "Priority support"]
  
  isActive      Boolean          @default(true)
  createdAt     DateTime         @default(now())
  
  @@index([tier])
}

// ============================================
// CLOTHING & OUTFITS
// ============================================

enum ClothingCategory {
  TOPS
  BOTTOMS
  DRESSES
  OUTERWEAR
  SHOES
  ACCESSORIES
  BAGS
  ACTIVEWEAR
  FORMAL
  SWIMWEAR
  UNDERWEAR
  OTHER
}

model ClothingItem {
  id          String           @id @default(cuid())
  userId      String
  user        User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Item details
  name        String?
  category    ClothingCategory
  color       String?
  brand       String?
  tags        String[]
  imagePath   String?
  
  // AI-generated data
  aiDescription String?
  aiTags        String[]
  
  // Timestamps
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  
  // Relations
  outfitItems OutfitItem[]
  
  @@index([userId])
  @@index([category])
}

model Outfit {
  id          String       @id @default(cuid())
  userId      String
  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Outfit details
  name        String?
  occasion    String?
  prompt      String?      // User's original prompt
  aiResponse  String?      // Full AI response (JSON)
  
  // Ratings
  rating      Int?         // 1-5 stars
  isFavorite  Boolean      @default(false)
  
  // Timestamps
  createdAt   DateTime     @default(now())
  wornAt      DateTime?    // Last time this outfit was worn
  
  // Relations
  items       OutfitItem[]
  
  @@index([userId])
  @@index([isFavorite])
  @@index([createdAt])
}

model OutfitItem {
  id             String       @id @default(cuid())
  outfitId       String
  outfit         Outfit       @relation(fields: [outfitId], references: [id], onDelete: Cascade)
  clothingItemId String
  clothingItem   ClothingItem @relation(fields: [clothingItemId], references: [id], onDelete: Cascade)
  
  @@unique([outfitId, clothingItemId])
}

// ============================================
// USAGE TRACKING & ANALYTICS
// ============================================

enum UsageAction {
  OUTFIT_GENERATED
  CLOTHING_ADDED
  OUTFIT_SAVED
  OUTFIT_SHARED
  INSPIRATION_VIEWED
  SUBSCRIPTION_STARTED
  SUBSCRIPTION_CANCELED
  TRYON_GENERATED
}

model UsageLog {
  id        String      @id @default(cuid())
  userId    String
  user      User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  action    UsageAction
  metadata  Json?       // Additional action-specific data
  
  createdAt DateTime    @default(now())
  
  @@index([userId])
  @@index([action])
  @@index([createdAt])
}
